<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gr치ficas IoT</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; background: #f5f5f5; padding: 20px; }
    canvas { background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 40px; }
    h1 { color: #007bff; }
    .chart-container { width: 90%; margin: auto; }
  </style>
</head>
<body>
  <h1>游늳 Gr치ficas din치micas de lecturas IoT</h1>
  <p><a href="/readings/">游댗 Ver tabla</a></p>

  <div id="charts" class="chart-container"></div>

  <script>
    // JSON desde Django ya serializado
    const readings = {{ readings_json|safe }};
    console.log("Datos recibidos:", readings);

    if (!readings.length) {
      document.getElementById("charts").innerHTML = "<p>No hay datos disponibles.</p>";
    } else {
      // Campo de tiempo
      const timeKey = "ts";
      const labels = readings.map(r => new Date(r[timeKey]).toLocaleTimeString());

      // Campos num칠ricos a graficar
      const numericKeys = ["level_pct", "flow_lpm", "water_temp_c", "humidity_pct"];

      numericKeys.forEach((key, i) => {
        // Crear canvas
        const canvas = document.createElement("canvas");
        canvas.id = `chart_${key}`;
        document.getElementById("charts").appendChild(canvas);

        // Extraer los valores
        const data = readings.map(r => r[key]);
        const color = `hsl(${i * 80}, 70%, 50%)`;

        // Crear la gr치fica
        new Chart(canvas, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: key,
              data,
              borderColor: color,
              backgroundColor: color + '33',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: key.replaceAll('_', ' ') }
            },
            scales: {
              x: { title: { display: true, text: "Tiempo (ts)" } },
              y: { title: { display: true, text: key } }
            }
          }
        });
      });
    }
  </script>
	<script>
  setInterval(async () => {
    const response = await fetch("https://iottinaco.onrender.com/readings/all");
    const newData = await response.json();
    console.log("Datos actualizados:", newData);
    location.reload(); // recarga la p치gina (simple pero efectivo)
  }, 15000);
</script>
</body>
</html>
